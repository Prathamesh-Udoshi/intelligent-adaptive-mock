<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evolutionary Mock Suite</title>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .panel {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border: 1px solid #333;
        }

        h1 {
            margin: 0 0 20px 0;
            color: #00d4ff;
            font-size: 24px;
        }

        h2 {
            font-size: 18px;
            color: #aaa;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        /* Controls */
        .control-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        input[type=range] {
            width: 100%;
            accent-color: #ff4757;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #2d2d2d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .btn {
            background: #00d4ff;
            color: #121212;
            border: none;
            padding: 10px 15px;
            width: 100%;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn:hover {
            background: #40e0ff;
        }

        .btn.test {
            background: #ff4757;
            color: white;
            margin-top: 10px;
        }

        /* Stats */
        .val-large {
            font-size: 32px;
            font-weight: bold;
            color: #fff;
        }

        .val-sub {
            font-size: 14px;
            color: #888;
        }

        /* Logs */
        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-family: monospace;
            font-size: 13px;
        }

        .log-table th {
            text-align: left;
            color: #888;
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        .log-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #252525;
            color: #ccc;
        }

        .status-ok {
            color: #0f0;
        }

        .status-err {
            color: #f00;
        }

        .badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .badge-ai {
            background: #2b1d52;
            color: #a48eff;
            border: 1px solid #5643a0;
        }

        .badge-real {
            background: #163016;
            color: #5cb85c;
            border: 1px solid #2d5a2d;
        }

        .badge-proxy {
            background: #3d3d3d;
            color: #aaa;
        }

        #logContainer {
            height: 350px;
            overflow-y: auto;
            margin-top: 20px;
        }

        #chartContainer {
            height: 250px;
            width: 100%;
        }
    </style>
</head>

<body>

    <div class="grid">
        <!-- Controls Panel -->
        <div class="panel">
            <h1>ðŸ”§ Control Deck</h1>

            <div class="control-group">
                <h2>Chaos Engine</h2>
                <div class="val-large"><span id="chaosVal">0</span>%</div>
                <input type="range" min="0" max="100" value="0" id="chaosRange">
                <div class="val-sub">Artificial Failure Probability</div>
            </div>

            <div class="control-group">
                <h2>Platform Configuration</h2>

                <div class="toggle-switch">
                    <span>ðŸ§  Global Learning</span>
                    <input type="checkbox" id="learningToggle">
                </div>
                <div class="val-sub" style="margin-top:-5px; margin-bottom: 20px;">Update AI model from Proxy traffic
                </div>

                <div
                    style="margin-bottom: 5px; color: #888; font-size: 11px; text-transform: uppercase; font-weight: bold;">
                    Global Operation Mode</div>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <button id="modeProxy" class="btn" style="flex: 1; padding: 6px;" onclick="setMode('proxy')">Ghost
                        (Proxy)</button>
                    <button id="modeMock" class="btn" style="flex: 1; padding: 6px;" onclick="setMode('mock')">Rocket
                        (Mock)</button>
                </div>
                <div class="val-sub">Determines behavior for external apps without headers</div>
            </div>

            <!-- Onboarding Walkthrough -->
            <div class="control-group" id="walkthroughPanel" style="background: #1e1e1e; border: 1px dashed #444;">
                <h2 style="color: #a48eff;">ðŸš€ Getting Started</h2>
                <div style="font-size: 12px; line-height: 1.6; color: #aaa;">
                    <p><b>1. Ghost Mode (Proxy)</b>: Keep this on while using your real app. The AI ðŸ§  is watching and
                        learning patterns.</p>
                    <p><b>2. Smart Normalization</b>: Notice how <code style="color:#eee;">/users/1</code> becomes <code
                            style="color:#eee;">/users/{id}</code> in the dropdown below.</p>
                    <p><b>3. Rocket Mode (Mock)</b>: Turn off your real backend. The Platform will now take over using
                        its learned behavior!</p>
                    <p><b>4. Chaos Injection</b>: Slide the bar left to simulate network instability or 500 errors.</p>
                </div>
                <button class="btn" onclick="document.getElementById('walkthroughPanel').style.display='none'"
                    style="background: transparent; border: 1px solid #444; color: #666; font-size: 10px; margin-top: 10px;">Dismiss
                    Guide</button>
            </div>

            <div class="control-group">
                <h2>Test Console</h2>
                <select id="endpointSelect"
                    style="width: 100%; background: #2d2d2d; color: white; border: 1px solid #444; padding: 8px; border-radius: 6px; margin-bottom: 10px;">
                    <!-- Dynamically loaded from /admin/endpoints -->
                </select>
                <button class="btn test" onclick="sendTestRequest()">Rocket Fire (Mock)</button>
                <div style="margin-top: 5px;"></div>
                <button class="btn" onclick="sendProxyRequest()">Ghost Fire (Proxy)</button>
                <div style="margin-top: 15px;">
                    <button class="btn" style="background: #333; color: #aaa;"
                        onclick="window.open('/admin/explorer', '_blank')">Visual Endpoint Explorer</button>
                    <div style="margin-top: 5px;"></div>
                    <button class="btn" style="background: #2b1d52; color: #a48eff; border: 1px solid #5643a0;"
                        onclick="window.open('/admin/docs', '_blank')">Interactive API Docs (Swagger)</button>
                    <div style="margin-top: 10px; font-size: 10px; text-align: center;">
                        <a href="/admin/export-openapi" target="_blank" style="color: #444;">Raw JSON Spec</a> |
                        <a href="/admin/endpoints" target="_blank" style="color: #444;">Raw Endpoints</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Visualization & Logs -->
        <div class="panel" style="padding: 0; overflow: hidden; display: flex; flex-direction: column;">

            <div style="padding: 20px; border-bottom: 1px solid #333; background: #252525;">
                <h2 style="margin:0; border:none;">ðŸ“Š Latency Monitor</h2>
            </div>

            <div style="padding: 20px;">
                <canvas id="latencyChart" style="height: 200px; max-height: 200px; width: 100%;"></canvas>
            </div>

            <div
                style="padding: 10px 20px; border-top: 1px solid #333; background: #252525; border-bottom: 1px solid #333;">
                <h2 style="margin:0; border:none; font-size: 14px;">ðŸ“¡ Live Stream</h2>
            </div>

            <div id="logContainer">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Method</th>
                            <th>Status</th>
                            <th>Latency</th>
                        </tr>
                    </thead>
                    <tbody id="logBody">
                        <!-- Logs go here -->
                    </tbody>
                </table>
            </div>

            <!-- Schema Inspector Panel -->
            <div
                style="background: #1a1a1a; flex: 1; border-top: 1px solid #333; display: flex; flex-direction: column;">
                <div
                    style="padding: 10px 20px; background: #252525; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin:0; border:none; font-size: 14px; color: #a48eff;">ðŸ§  Schema Brain (AI Knowledge)
                    </h2>
                    <button class="btn" style="width: auto; padding: 4px 10px; font-size: 11px;"
                        onclick="saveSchema()">Override AI Knowledge</button>
                </div>
                <textarea id="schemaEditor"
                    style="flex: 1; background: #121212; color: #00ff00; border: none; padding: 15px; font-family: monospace; font-size: 12px; resize: none; overflow-y: auto;"
                    spellcheck="false">
/* Select an endpoint to inspect its learned schema */
                </textarea>
            </div>
        </div>
    </div>

    <script>
        const slider = document.getElementById("chaosRange");
        const output = document.getElementById("chaosVal");
        const learningToggle = document.getElementById("learningToggle");
        const logBody = document.getElementById("logBody");
        const ctx = document.getElementById('latencyChart').getContext('2d');

        // Chart.js Setup
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Mock Latency (AI)',
                        borderColor: '#a48eff',
                        backgroundColor: 'rgba(164, 142, 255, 0.1)',
                        data: [],
                        tension: 0.3
                    },
                    {
                        label: 'Real Latency (Proxy)',
                        borderColor: '#5cb85c',
                        backgroundColor: 'rgba(92, 184, 92, 0.1)',
                        data: [],
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false },
                    y: { beginAtZero: true, grid: { color: '#333' } }
                },
                plugins: {
                    legend: { labels: { color: '#ccc' } }
                }
            }
        });

        function updateChart(latency, type) {
            const now = new Date().toLocaleTimeString();

            // Remove old data if > 20 points
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
                chart.data.datasets[1].data.shift();
            }

            chart.data.labels.push(now);

            if (type === "Mock") {
                chart.data.datasets[0].data.push(latency);
                chart.data.datasets[1].data.push(null); // Gap for other line
            } else {
                chart.data.datasets[0].data.push(null);
                chart.data.datasets[1].data.push(latency);
            }

            chart.update();
        }

        // Init
        syncConfig();

        // Event Listeners
        slider.onchange = async function () {
            output.innerHTML = this.value;
            await fetch('/admin/chaos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ level: this.value })
            });
        }

        slider.oninput = function () { output.innerHTML = this.value; }

        learningToggle.onchange = async function () {
            await fetch('/admin/learning', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled: this.checked })
            });
        }

        async function setMode(mode) {
            await fetch('/admin/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: mode })
            });
            updateModeUI(mode);
        }

        function updateModeUI(mode) {
            const proxyBtn = document.getElementById("modeProxy");
            const mockBtn = document.getElementById("modeMock");

            if (mode === 'proxy') {
                proxyBtn.classList.add('active-mode');
                proxyBtn.style.background = '#5cb85c'; // Green for Proxy
                mockBtn.classList.remove('active-mode');
                mockBtn.style.background = '#333';
            } else {
                mockBtn.classList.add('active-mode');
                mockBtn.style.background = '#a48eff'; // Purple for Mock
                proxyBtn.classList.remove('active-mode');
                proxyBtn.style.background = '#333';
            }
        }

        document.getElementById("endpointSelect").onchange = async function () {
            await loadEndpointDetails(this.value);
        };

        async function loadEndpointDetails(pathPattern) {
            if (!pathPattern) return;
            try {
                const res = await fetch('/admin/endpoints');
                const endpoints = await res.json();
                const ep = endpoints.find(e => e.path_pattern === pathPattern);
                if (!ep) return;

                const statsRes = await fetch(`/admin/endpoints/${ep.id}/stats`);
                const stats = await statsRes.json();

                document.getElementById("schemaEditor").value = JSON.stringify(stats.behavior.schema_preview || {}, null, 4);

                // Also sync chaos for this specific endpoint
                slider.value = stats.chaos.level;
                output.innerHTML = stats.chaos.level;
            } catch (e) { console.error("Failed to load details", e); }
        }

        async function saveSchema() {
            const select = document.getElementById("endpointSelect");
            const pathPattern = select.value;
            if (!pathPattern) return alert("Select an endpoint first");

            try {
                const res = await fetch('/admin/endpoints');
                const endpoints = await res.json();
                const ep = endpoints.find(e => e.path_pattern === pathPattern);

                const newSchema = JSON.parse(document.getElementById("schemaEditor").value);

                await fetch(`/admin/endpoints/${ep.id}/schema`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newSchema)
                });
                alert("AI Knowledge Overridden Successfully!");
            } catch (e) { alert("Invalid JSON or Save Failed"); }
        }


        async function loadEndpoints() {
            try {
                const res = await fetch('/admin/endpoints');
                const endpoints = await res.json();
                const select = document.getElementById("endpointSelect");
                const currentVal = select.value;

                select.innerHTML = "";
                endpoints.forEach(ep => {
                    const opt = document.createElement("option");
                    opt.value = ep.path_pattern;
                    opt.textContent = `${ep.path_pattern} (${ep.method})`;
                    if (ep.path_pattern === currentVal) opt.selected = true;
                    select.appendChild(opt);
                });

                // Add "Help" option if empty
                if (endpoints.length === 0) {
                    select.innerHTML = '<option value="">No endpoints learned yet...</option>';
                } else if (!currentVal) {
                    // Load details for first endpoint if none selected
                    await loadEndpointDetails(endpoints[0].path_pattern);
                }
            } catch (e) { console.error("Failed to load endpoints", e); }
        }

        async function syncConfig() {
            try {
                const res = await fetch('/admin/config');
                const data = await res.json();
                slider.value = data.chaos_level;
                output.innerHTML = data.chaos_level;
                learningToggle.checked = data.learning_mode;
                updateModeUI(data.platform_mode);
                await loadEndpoints();
            } catch (e) { console.error("Sync failed", e); }
        }

        async function sendTestRequest() {
            const ep = document.getElementById("endpointSelect").value;
            const res = await req(ep, { 'X-Mock-Enabled': 'true' });
            addLog(res, "Mock", ep);
        }

        async function sendProxyRequest() {
            const ep = document.getElementById("endpointSelect").value;
            if (!ep) return;
            await req(ep, { 'X-Mock-Enabled': 'false' });
            // Refresh in case we learned something new
            await loadEndpoints();
        }

        async function syncLogs() {
            try {
                const res = await fetch('/admin/logs');
                const logs = await res.json();

                // Clear and rebuild log table
                logBody.innerHTML = "";
                logs.forEach(log => {
                    const row = document.createElement("tr");
                    const statusClass = (log.status >= 200 && log.status < 300) ? "status-ok" : "status-err";
                    const badgeClass = log.type === "Mock" ? "badge-ai" : "badge-real";

                    row.innerHTML = `
                        <td>${log.time}</td>
                        <td><span class="badge ${badgeClass}">${log.type}</span></td>
                        <td>${log.method} ${log.path}</td>
                        <td class="${statusClass}">${log.status}</td>
                        <td>${log.latency} ms</td>
                    `;
                    logBody.appendChild(row);
                });

                // Update chart with the latest log if it's new
                if (logs.length > 0) {
                    const latest = logs[0];
                    // Simple deduplication for chart (don't add if time/path is same as last)
                    if (window.lastLogTime !== latest.time) {
                        updateChart(latest.latency, latest.type);
                        window.lastLogTime = latest.time;
                    }
                }
            } catch (e) { console.error("Log sync failed", e); }
        }

        setInterval(syncLogs, 1500);

        async function req(url, headers) {
            const start = Date.now();
            let status = 0;
            let data = {};
            const method = (url.includes("payment") || url.includes("orders")) ? "POST" : "GET";
            try {
                const fetchOpts = {
                    method: method,
                    headers: { 'Content-Type': 'application/json', ...headers }
                };
                if (method === "POST") {
                    fetchOpts.body = JSON.stringify({ amount: 50, currency: "USD" });
                }

                const r = await fetch(url, fetchOpts);
                status = r.status;
                data = await r.json();
            } catch (e) {
                status = "ERR";
            }
            const lat = Date.now() - start;
            return { status, lat, data };
        }

    </script>

</body>

</html>